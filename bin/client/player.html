<html>
	<head>
		<title>Media player and file viewer</title>
		<style>
*
{
	margin: 0;
	padding: 0;
	max-width: 100%;
	max-height: 100vh;
}
		</style>
	</head>
	<body>
		<div id="contentHolder"><p>loading javascript...</p></div>
		<script>
function render(content)
{
	document.getElementById("contentHolder").innerHTML = content;
}

function getProtocol()
{
	return window.location.protocol + "//";
}

function getDomain()
{
	return window.location.hostname;
}

function getPort()
{
	return window.location.port;
}

function getProtocolAndDomain()
{
	return getProtocol() + getDomain() + ":" + getPort();
}

function renderMedia(fileHash)
{
	var postContent = "";
	
	var imageRequest = new XMLHttpRequest();
	imageRequest.onreadystatechange = function() {
		if (imageRequest.readyState == 4 && imageRequest.status == 200)
		{
			var dataContent = imageRequest.responseText.toString().replace(/(data:)?((\w+\/\w+)(;charset=.*)?)?(;base64)?,(.*)/, "$1");
			var mimeType = imageRequest.responseText.toString().replace(/(data:)?((\w+\/\w+)(;charset=.*)?)?(;base64)?,(.*)/, "$2");
			
			
			if (dataContent === "data:")
			{
				//video embed
				if (mimeType.replace(/((\w+)\/\w+)(;charset=.*)?/, "$2") === "video")
				{
					postContent += '<video controls><source src="' + imageRequest.responseText + '" type="' + mimeType + '"><p>' + "file: " + fileHash + " (" + mimeType + ")" + '</p></video>';
				}
				
				//image embed
				if (mimeType.replace(/((\w+)\/\w+)(;charset=.*)?/, "$2") === "image")
				{
					postContent += "<img src='" + imageRequest.responseText + "' style='max-width:90%;' alt='" + mimeType + "' />";
				}
				
				//audio embed
				if (mimeType.replace(/((\w+)\/\w+)(;charset=.*)?/, "$2") === "audio")
				{
					postContent += "<audio controls><source src='" + imageRequest.responseText + "' type='" + mimeType + "'><p>" + "file: " + fileHash + " (" + mimeType + ")" +  "</p></audio>";
				}
			}
			else
			{
				//if not empty file
				if (fileHash !== "QmbFMke1KXqnYyBBWxB74N4c5SBnJMVAiMNRcGu6x1AwQH")
				{
					//just output file hash
					postContent += "<p>file: " + fileHash + " (" + mimeType + ")" +  "</p>";
				}
				else
				{
					postContent += "<p>The requested hash is the blank file</p>";
				}
			}
			
			render(postContent);
		}
	}
	imageRequest.open("GET", getProtocolAndDomain() + "/ipfs/" + fileHash);
	imageRequest.send();
}

function main()
{
	render("<p>loading file...</p>");
	
	if(window.location.hash)
	{
		// Fragment exists
		renderMedia(window.location.hash.replace(/#(.*)/, "$1"));
	}
	else
	{
		// Fragment doesn't exist
		render("<p>include an IPFS hash after the URL like so: /ipfs/&lt;hash&gt;#&lt;secondHash&gt;</p>")
	}
	
	//TODO: option to download as file
}

main();
		</script>
	</body>
</html>
